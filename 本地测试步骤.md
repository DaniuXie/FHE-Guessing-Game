# 🧪 本地测试步骤指南

## ✅ 已完成的测试

- ✅ 合约编译测试 - **通过**
- ✅ 前端构建测试 - **通过**
- ✅ 代码质量检查 - **通过**

---

## 🚀 下一步：本地功能测试

### 方案 A: 本地 Hardhat 网络测试（推荐用于快速验证）

#### 步骤 1: 启动本地节点

打开**第一个终端**：
```bash
cd E:\ZAMAcode\02
npx hardhat node
```

**保持这个终端运行**，你会看到：
```
Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/
Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
...
```

#### 步骤 2: 部署合约

打开**第二个终端**：
```bash
cd E:\ZAMAcode\02
npx hardhat run scripts/deploy_fhe_v3.js --network localhost
```

**记录合约地址**，例如：
```
✅ 合约已部署!
📍 合约地址: 0x5FbDB2315678afecb367f032d93F642f64180aa3
```

#### 步骤 3: 更新前端配置

编辑 `frontend/src/utils/constants_fhe.ts`，更新合约地址：

```typescript
// 本地测试
export const CONTRACT_ADDRESS_FHE = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
```

同时，在 `frontend/src/utils/relayerClient.ts` 中，临时改为 local 网络：

```typescript
// 临时改为 local 进行测试
const relayerClient = new RelayerClient('local'); // 改为 'local'
```

**注意**：本地网络没有真实的 Gateway，解密功能无法完整测试。

#### 步骤 4: 启动前端

打开**第三个终端**：
```bash
cd E:\ZAMAcode\02\frontend
npm run dev
```

浏览器打开：`http://localhost:5173`

#### 步骤 5: 测试基础功能

- [x] 连接钱包（使用本地账户）
- [x] 切换到 FHE 模式
- [x] 创建游戏（测试加密功能）
- [x] 查看游戏列表
- [x] 检查是否有错误

**限制**：本地网络无法测试真实的 Gateway 解密。

---

### 方案 B: Sepolia 测试网（推荐用于完整测试）

#### 前置要求

1. **准备测试账户**
   - Sepolia 测试网的 ETH（通过水龙头获取）
   - 私钥

2. **配置环境变量**

创建/编辑 `.env` 文件：
```bash
PRIVATE_KEY=你的私钥（不要0x前缀）
INFURA_API_KEY=你的Infura API密钥
```

#### 步骤 1: 部署到 Sepolia

```bash
cd E:\ZAMAcode\02
npx hardhat run scripts/deploy_fhe_v3.js --network sepolia
```

等待部署完成（可能需要1-2分钟）：
```
🚀 部署 GuessGameFHE_v3 (升级版) ...
✅ 合约已部署!
📍 合约地址: 0x...
🔗 Etherscan: https://sepolia.etherscan.io/address/0x...
```

#### 步骤 2: 验证升级

```bash
npx hardhat run scripts/test_v3_upgrade.js --network sepolia
```

检查输出：
```
🧪 验证 GuessGameFHE_v3 升级效果
✅ Gas Limit 正确 (500000)
✅ 所有方法存在
✅ 事件系统完整
🎉 所有测试通过！
```

#### 步骤 3: 更新前端配置

编辑 `frontend/src/utils/constants_fhe.ts`：

```typescript
export const CONTRACT_ADDRESS_FHE = "0x你的Sepolia合约地址";
```

确保 `relayerClient.ts` 使用 sepolia：

```typescript
const relayerClient = new RelayerClient('sepolia'); // ✅ 正确
```

#### 步骤 4: 启动前端

```bash
cd frontend
npm run dev
```

#### 步骤 5: 完整功能测试

1. **连接钱包**
   - 切换 MetaMask 到 Sepolia 网络
   - 连接钱包

2. **创建游戏**
   - 切换到 "FHE Version"
   - 输入目标数字（例如：42）
   - 设置入场费（例如：0.001 ETH）
   - 点击 "Create Game"
   - 等待交易确认

3. **玩家加入**（使用另一个账户）
   - 输入游戏 ID
   - 输入猜测数字
   - 支付入场费
   - 点击 "Join Game"

4. **测试解密流程** ⭐ 核心测试
   - 点击 "🔐 End Game (FHE Decryption)"
   - **观察进度模态框**：
     - [ ] 显示进度条
     - [ ] 状态从 "requesting" → "polling" → "waiting" → "success"
     - [ ] 进度从 0% → 100%
     - [ ] 显示阶段说明
   - **预计耗时**：1-2 分钟
   - **确认结果**：
     - [ ] 目标数字正确显示
     - [ ] 获胜者正确计算
     - [ ] 奖金正确转账

5. **测试重试功能**（如果需要）
   - 如果解密失败，点击 "🔄 重试"
   - 观察是否能重新开始解密流程

---

## 📊 预期结果

### 成功标志 ✅

1. **编译层面**
   - ✅ 合约无错误编译
   - ✅ 前端无错误构建

2. **基础功能**
   - ✅ 创建游戏成功
   - ✅ 玩家加入成功
   - ✅ 游戏信息正确显示

3. **核心功能（仅 Sepolia）**
   - ✅ 解密请求提交成功
   - ✅ 进度条正确显示
   - ✅ Gateway 解密完成
   - ✅ 链上回调成功
   - ✅ 最终结果正确

### 常见问题

#### Q1: "Gateway 解密超时"

**原因**：网络问题或 Gateway 负载高

**解决**：
1. 等待 2-3 分钟
2. 点击"重试"按钮
3. 检查网络连接

#### Q2: "前端无法连接合约"

**原因**：合约地址未更新或网络不匹配

**解决**：
1. 检查 `constants_fhe.ts` 中的地址
2. 确认 MetaMask 在正确的网络
3. 清除浏览器缓存

#### Q3: "编译出现 FHEVM 相关错误"

**原因**：FHEVM 依赖未正确安装

**解决**：
```bash
npm install
cd frontend && npm install
```

---

## 📝 测试报告模板

测试完成后，记录结果：

```
测试日期：2025-10-29
测试网络：[ ] 本地  [x] Sepolia
测试人员：[你的名字]

基础功能：
- [ ] 创建游戏
- [ ] 玩家加入
- [ ] 游戏列表显示

解密功能（核心）：
- [ ] 解密请求提交
- [ ] 进度条显示
- [ ] Gateway 轮询
- [ ] 链上回调
- [ ] 结果显示

问题记录：
[如有问题，在此记录]

总体评价：
[ ] 完全成功  [ ] 部分成功  [ ] 失败

备注：
[其他说明]
```

---

## 🎯 建议

1. **先本地测试基础功能**（方案A）
   - 确保创建游戏、加入游戏无问题
   - 验证前端界面正常

2. **再 Sepolia 完整测试**（方案B）
   - 测试真实的 FHE 解密流程
   - 验证 Gateway 集成
   - 确认进度展示效果

3. **记录测试结果**
   - 截图关键步骤
   - 记录遇到的问题
   - 准备参赛材料

---

**准备好了吗？选择一个方案开始测试吧！** 🚀

有问题随时查看 [UPGRADE_GUIDE.md](./UPGRADE_GUIDE.md) 或询问我！

