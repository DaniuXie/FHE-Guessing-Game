# 🚀 安装和使用指南

## 📋 前提条件

在开始之前，请确保您的系统已安装：

- **Node.js** 18+ ([下载](https://nodejs.org/))
- **npm** 或 **yarn** 包管理器
- **MetaMask** 浏览器插件 ([安装](https://metamask.io/download/))
- **Sepolia测试币** ([水龙头](https://sepoliafaucet.com/))

---

## 🔧 安装步骤

### 1. 安装项目依赖

```bash
# 安装合约依赖
npm install

# 安装前端依赖
cd frontend
npm install
cd ..
```

### 2. 配置环境变量

复制 `.env.example` 到 `.env` 并填写配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件：

```env
# Alchemy API Key (从 https://www.alchemy.com/ 获取)
ALCHEMY_KEY=your_alchemy_api_key_here

# 部署账户助记词（12个单词）
MNEMONIC=your twelve word mnemonic phrase goes here

# 或使用私钥（二选一）
# PRIVATE_KEY=your_private_key_here
```

### 3. 编译智能合约

```bash
npx hardhat compile
```

成功输出：
```
✅ Compiled 1 Solidity file successfully
```

---

## 🚀 部署和测试

### 方式A: 完整自动化测试

运行完整测试流程（推荐第一次使用）：

```bash
node scripts/full_test_flow.js
```

这将自动执行：
1. 部署合约到 Sepolia
2. 创建测试游戏
3. 加入游戏
4. 结束游戏

### 方式B: 手动分步测试

#### 步骤1: 部署合约

```bash
npm run deploy
```

输出示例：
```
🚀 开始部署 GuessGame 合约...
📍 部署账户: 0x1234...5678
💰 账户余额: 0.5 ETH
✅ 部署成功!
📍 合约地址: 0xabcd...efgh
```

#### 步骤2: 创建游戏

```bash
npm run create-game
```

这将：
- 加密目标数字（默认：42）
- 设置入场费（默认：0.001 ETH）
- 创建游戏并返回游戏ID

#### 步骤3: 加入游戏

```bash
npm run join-game
```

这将：
- 加密你的猜测（默认：50）
- 支付入场费
- 提交猜测到游戏

#### 步骤4: 结束游戏

```bash
npm run end-game
```

这将：
- 触发FHE计算
- 请求Gateway解密
- 确定获胜者
- 分配奖池

⚠️ **注意**：Gateway解密是异步的，可能需要1-5分钟才能看到最终结果。

---

## 💻 启动前端

### 1. 更新合约地址

编辑 `frontend/src/utils/constants.ts`：

```typescript
// 替换为你部署的合约地址
export const CONTRACT_ADDRESS = "0xYourContractAddress";
```

### 2. 更新Alchemy Key

同样在 `constants.ts` 中：

```typescript
export const FHEVM_CONFIG = {
  // ...
  networkUrl: "https://eth-sepolia.g.alchemy.com/v2/YOUR_ALCHEMY_KEY",
  // ...
};
```

### 3. 启动开发服务器

```bash
cd frontend
npm run dev
```

浏览器会自动打开 `http://localhost:5173`

---

## 🎮 使用前端界面

### 1. 连接钱包

点击右上角"连接钱包"按钮：
- 授权MetaMask访问
- 确保在Sepolia网络上
- 确认钱包地址显示

### 2. 创建游戏

1. 点击"➕ 创建游戏"标签
2. 输入目标数字（1-100）
3. 设置入场费（0.0001-1 ETH）
4. 点击"创建游戏"
5. 在MetaMask中确认交易

### 3. 加入游戏

1. 在游戏列表中点击一个游戏
2. 点击"🎯 加入游戏"标签
3. 输入你的猜测（1-100）
4. 点击"加入"并支付入场费
5. 在MetaMask中确认交易

### 4. 结束游戏（仅房主）

1. 点击"📊 游戏详情"标签
2. 确认有玩家参与
3. 点击"🏁 结束游戏并计算结果"
4. 在MetaMask中确认交易
5. 等待1-5分钟查看结果

---

## 🔍 故障排除

### 问题1: 合约部署失败

**症状**: `insufficient funds for gas`

**解决方案**:
```bash
# 访问水龙头获取测试币
https://sepoliafaucet.com/
```

### 问题2: FHEVM SDK初始化失败

**症状**: `FHEVM SDK 初始化失败`

**解决方案**:
1. 检查网络连接
2. 确认Alchemy Key正确
3. 刷新页面重试

### 问题3: 交易revert

**症状**: `execution reverted`

**可能原因**:
- Gas不足
- 游戏状态不正确
- 已经提交过猜测

**解决方案**:
```bash
# 查看交易详情
https://sepolia.etherscan.io/tx/YOUR_TX_HASH
```

### 问题4: Gateway解密超时

**症状**: 游戏一直在"计算中"状态

**解决方案**:
- Gateway解密通常需要1-5分钟
- 刷新页面查看最新状态
- 查看[Gateway状态](https://gateway.sepolia.zama.ai/)

### 问题5: MetaMask连接失败

**症状**: 无法连接钱包

**解决方案**:
1. 确认已安装MetaMask
2. 解锁MetaMask
3. 刷新页面
4. 手动切换到Sepolia网络

---

## 📚 常用命令

```bash
# 合约相关
npm run compile        # 编译合约
npm run deploy         # 部署到Sepolia
npm run create-game    # 创建测试游戏
npm run join-game      # 加入游戏
npm run end-game       # 结束游戏
npm run full-test      # 完整测试流程

# 前端相关
cd frontend
npm run dev            # 开发服务器
npm run build          # 生产构建
npm run preview        # 预览构建结果

# 清理
npx hardhat clean      # 清理编译产物
```

---

## 🔗 有用的链接

- **Sepolia浏览器**: https://sepolia.etherscan.io/
- **Sepolia水龙头**: https://sepoliafaucet.com/
- **Zama文档**: https://docs.zama.ai/
- **FHEVM文档**: https://docs.zama.ai/fhevm
- **Relayer SDK**: https://docs.zama.ai/fhevm/guides/relayer-sdk
- **Gateway状态**: https://gateway.sepolia.zama.ai/

---

## 💡 开发技巧

### 1. 监听合约事件

```javascript
// 在浏览器控制台
contract.on("GameCreated", (gameId, owner, entryFee) => {
  console.log("Game created:", { gameId, owner, entryFee });
});
```

### 2. 查询链上数据

```javascript
// 获取游戏信息
const info = await contract.getGameInfo(1);
console.log(info);

// 获取玩家列表
const players = await contract.getPlayers(1);
console.log(players);
```

### 3. 测试多账户场景

在 `hardhat.config.js` 中配置：

```javascript
accounts: {
  mnemonic: MNEMONIC,
  count: 10,  // 生成10个测试账户
}
```

### 4. 调试交易

```bash
# 使用Hardhat Console
npx hardhat console --network sepolia

# 查看交易收据
const tx = await ethers.provider.getTransaction("TX_HASH");
console.log(tx);
```

---

## 🎓 下一步

1. 📖 阅读 [README.md](./README.md) 了解项目架构
2. 🐛 查看 [update_debug_log.md](./update_debug_log.md) 了解开发进度
3. 📝 查看 [自查日志.md](./自查日志.md) 了解最佳实践
4. 🔐 学习 [Sepolia + fhEVM Coprocessor 解决方案.txt](./Sepolia%20+%20fhEVM%20Coprocessor%20解决方案.txt)

---

## ✅ 检查清单

部署前检查：
- [ ] Node.js 18+ 已安装
- [ ] 依赖已安装（npm install）
- [ ] .env 文件已配置
- [ ] Sepolia 测试币充足（>0.1 ETH）
- [ ] 合约编译成功

前端使用前检查：
- [ ] 合约已部署
- [ ] CONTRACT_ADDRESS 已更新
- [ ] ALCHEMY_KEY 已配置
- [ ] MetaMask 已安装
- [ ] 前端依赖已安装

---

**祝你使用愉快！** 🎉

如有问题，请查看文档或提交Issue。


