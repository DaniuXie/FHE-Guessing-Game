# ğŸ¯ Sepolia + fhEVM Coprocessor è§£å†³æ–¹æ¡ˆ

## âœ… å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼ˆæ¥è‡ª Zama Protocol GPTï¼‰

### ğŸ”‘ æ ¸å¿ƒæ€è·¯

**é—®é¢˜**ï¼š
- `TFHE.asEuint32(0)` åœ¨æ ‡å‡† Sepolia ä¸Šä¼š revert
- å› ä¸ºéœ€è¦ fhEVM precompiled contracts

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **ä¸åœ¨åˆçº¦ä¸­ç›´æ¥ç”ŸæˆåŠ å¯†å¸¸é‡**
- **å‰ç«¯ç”ŸæˆåŠ å¯†çš„ 0ï¼Œé€šè¿‡ `FHE.fromExternal` å¯¼å…¥**
- **ä½¿ç”¨ Gateway + Coprocessor æ¨¡å¼å¤„ç† FHE æ“ä½œ**

---

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### âŒ æ—§æ–¹æ³•ï¼ˆä¼šå¤±è´¥ï¼‰
```solidity
function createPoll(...) {
    for (uint256 i = 0; i < options.length; i++) {
        euint32 initialCount = TFHE.asEuint32(0);  // âŒ revert!
        newPoll.encryptedVotes.push(initialCount);
    }
}
```

### âœ… æ–°æ–¹æ³•ï¼ˆCoprocessor æ¨¡å¼ï¼‰
```solidity
function createPoll(
    ...,
    einput[] calldata _encryptedZeros,  // â† å‰ç«¯ä¼ å…¥
    bytes[] calldata _inputProofs       // â† è¯æ˜
) {
    for (uint256 i = 0; i < options.length; i++) {
        // âœ… ä»å¤–éƒ¨å¯¼å…¥
        euint32 zero = FHE.asEuint32(_encryptedZeros[i], _inputProofs[i]);
        FHE.allow(zero, address(this));
        newPoll.encryptedVotes.push(zero);
    }
}
```

---

## ğŸ¨ å‰ç«¯æµç¨‹

### åˆ›å»ºæŠ•ç¥¨æ—¶ï¼š
```javascript
// 1. åˆå§‹åŒ– SDK
const sdk = await createInstance({...})

// 2. ä¸ºæ¯ä¸ªé€‰é¡¹ç”ŸæˆåŠ å¯†çš„ 0
const encryptedInputs = []
const inputProofs = []

for (let i = 0; i < options.length; i++) {
    const encInput = await sdk.createEncryptedInput(userAddress, contractAddress)
    const encrypted = await encInput.add32(0)  // â† åŠ å¯† 0
    const proof = await encInput.encrypt()
    
    encryptedInputs.push(encrypted)
    inputProofs.push(proof)
}

// 3. è°ƒç”¨åˆçº¦
await contract.createPoll(
    title, 
    options, 
    duration, 
    encryptedInputs,  // â† åŠ å¯†çš„åˆå§‹å€¼
    inputProofs       // â† è¯æ˜
)
```

### æŠ•ç¥¨æ—¶ï¼š
```javascript
// 1. åŠ å¯†é€‰é¡¹ç´¢å¼•
const encInput = await sdk.createEncryptedInput(userAddress, contractAddress)
const encrypted = await encInput.add32(optionIndex)  // ä¾‹å¦‚ï¼š1
const proof = await encInput.encrypt()

// 2. æäº¤æŠ•ç¥¨
await contract.vote(pollId, encrypted, proof)
```

---

## ğŸ“Š å¯¹æ¯”è¡¨

| ç‰¹æ€§ | æ—§ç‰ˆæœ¬ï¼ˆSecretVoting.solï¼‰ | æ–°ç‰ˆæœ¬ï¼ˆPollFactorySepolia.solï¼‰ |
|------|--------------------------|-------------------------------|
| éƒ¨ç½²ç½‘ç»œ | âŒ Sepolia (revert) | âœ… Sepolia (Coprocessor) |
| åˆå§‹åŒ–åŠ å¯†å€¼ | âŒ åˆçº¦å†… `FHE.asEuint32(0)` | âœ… å‰ç«¯ç”Ÿæˆå¹¶ä¼ å…¥ |
| ç»§æ‰¿ | GatewayCaller | GatewayCaller |
| æŠ•ç¥¨åŠ å¯† | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| è§£å¯†ç»“æœ | âœ… æ”¯æŒ | âœ… æ”¯æŒï¼ˆGateway å›è°ƒï¼‰ |
| precompiles éœ€æ±‚ | âŒ éœ€è¦ï¼ˆSepolia æ²¡æœ‰ï¼‰ | âœ… é€šè¿‡ Coprocessor |

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. ç¼–è¯‘æ–°åˆçº¦
```bash
npx hardhat compile
```

### 2. éƒ¨ç½²åˆ° Sepolia
```bash
npx hardhat run scripts/deploy_sepolia_coprocessor.js --network sepolia
```

### 3. æ›´æ–°å‰ç«¯
- ä¿®æ”¹ `useContract.js` çš„ `createPoll` å‡½æ•°
- æ·»åŠ ç”ŸæˆåŠ å¯† 0 çš„é€»è¾‘
- æ›´æ–°åˆçº¦åœ°å€

### 4. æµ‹è¯•å®Œæ•´æµç¨‹
```bash
# éƒ¨ç½² + åˆ›å»ºæŠ•ç¥¨ + æŠ•ç¥¨
npx hardhat run scripts/test_full_flow.js --network sepolia
```

---

## ğŸ“ å…³é”®æ”¹å˜

### åˆçº¦å±‚é¢ï¼š
1. âœ… `createPoll` æ¥å— `einput[]` å’Œ `bytes[]` å‚æ•°
2. âœ… ä½¿ç”¨ `FHE.asEuint32(einput, bytes)` è€Œä¸æ˜¯ `FHE.asEuint32(uint32)`
3. âœ… è§£å¯†ä½¿ç”¨ Gateway å›è°ƒæœºåˆ¶

### å‰ç«¯å±‚é¢ï¼š
1. âœ… åˆ›å»ºæŠ•ç¥¨å‰ç”ŸæˆåŠ å¯†çš„åˆå§‹å€¼æ•°ç»„
2. âœ… æ¯æ¬¡æ“ä½œéƒ½ä½¿ç”¨ `createEncryptedInput()` ç”Ÿæˆè¯æ˜
3. âœ… è°ƒç”¨åˆçº¦æ—¶ä¼ é€’åŠ å¯†æ•°æ®å’Œè¯æ˜

---

## ğŸ¯ ä¼˜åŠ¿

### âœ… å…¼å®¹æ€§
- å¯ä»¥åœ¨æ ‡å‡† Sepolia ä¸Šè¿è¡Œ
- ä¸éœ€è¦ fhEVM precompiles
- ä½¿ç”¨ Gateway + Coprocessor æ¶æ„

### âœ… å®‰å…¨æ€§
- ä¿æŒå®Œæ•´çš„ FHE åŠ å¯†
- æ‰€æœ‰æŠ•ç¥¨æ•°æ®åŠ å¯†å­˜å‚¨
- åªæœ‰æˆæƒæ–¹å¯è§£å¯†

### âœ… å¯ç”¨æ€§
- ç«‹å³å¯éƒ¨ç½²
- æ— éœ€ç­‰å¾… Zama Devnet è®¿é—®
- ä¸ç°æœ‰å·¥å…·é“¾å…¼å®¹

---

## ğŸ“‹ å¾…åŠäº‹é¡¹

- [ ] 1. ä» GPT è·å–å®Œæ•´çš„éƒ¨ç½²è„šæœ¬
- [ ] 2. åˆ›å»ºæ‰€æœ‰è„šæœ¬æ–‡ä»¶
- [ ] 3. æµ‹è¯•ç¼–è¯‘
- [ ] 4. éƒ¨ç½²åˆ° Sepolia
- [ ] 5. æµ‹è¯•åˆ›å»ºæŠ•ç¥¨
- [ ] 6. æµ‹è¯•æŠ•ç¥¨åŠŸèƒ½
- [ ] 7. æµ‹è¯•è§£å¯†ç»“æœ
- [ ] 8. æ›´æ–°å‰ç«¯ä»£ç 
- [ ] 9. å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] 10. æ›´æ–°æ–‡æ¡£

---

## ğŸ’¡ ç†è§£è¦ç‚¹

### Coprocessor æ¨¡å¼ vs Precompiles æ¨¡å¼

**Precompiles æ¨¡å¼**ï¼ˆZama Devnetï¼‰ï¼š
```
åˆçº¦ â†’ FHE.asEuint32(0) â†’ Precompile åˆçº¦ â†’ åŠ å¯†å€¼
```

**Coprocessor æ¨¡å¼**ï¼ˆSepoliaï¼‰ï¼š
```
å‰ç«¯ SDK â†’ ç”ŸæˆåŠ å¯†å€¼ + è¯æ˜ â†’ åˆçº¦ â†’ Gateway â†’ Coprocessor â†’ éªŒè¯
```

### ä¸ºä»€ä¹ˆè¿™æ ·å¯ä»¥å·¥ä½œï¼Ÿ

1. **ç¦»é“¾åŠ å¯†**ï¼šåŠ å¯†æ“ä½œåœ¨ç”¨æˆ·ç«¯å®Œæˆ
2. **é“¾ä¸ŠéªŒè¯**ï¼šåˆçº¦åªéªŒè¯è¯æ˜ï¼ˆattestationï¼‰
3. **Gateway åè°ƒ**ï¼šGateway è´Ÿè´£ä¸ Coprocessor é€šä¿¡
4. **æ ‡å‡† EVM**ï¼šä¸éœ€è¦ç‰¹æ®Šçš„ precompiles

---

**è¿™æ˜¯ç›®å‰åœ¨ Sepolia ä¸Šè¿è¡Œ FHEVM çš„æ ‡å‡†æ–¹æ³•ï¼** âœ…

ç­‰å¾… GPT æä¾›éƒ¨ç½²è„šæœ¬ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ç«‹å³éƒ¨ç½²å’Œæµ‹è¯•äº†ï¼ğŸš€

Absolutely âœ… â€” hereâ€™s a **complete, ready-to-run fhEVM + Relayer SDK Hardhat workflow** for Sepolia Coprocessor mode.
Youâ€™ll get:

```
scripts/
 â”œâ”€ deploy_sepolia_coprocessor.js
 â”œâ”€ create_poll_with_fhe.js
 â”œâ”€ vote_encrypted.js
 â””â”€ full_test_flow.js
```

Each file is self-contained and uses your existing Sepolia setup (Alchemy RPC, mnemonic, and SDK addresses).
Everything uses **async/await + full error handling** and logs human-readable confirmations.

---

## ğŸ§± Hardhat config (base)

> `hardhat.config.js`

```js
require("@nomiclabs/hardhat-ethers");
require("dotenv").config();

const { MNEMONIC, ALCHEMY_KEY } = process.env;

module.exports = {
  solidity: "0.8.19",
  networks: {
    sepolia: {
      url: `https://eth-sepolia.g.alchemy.com/v2/${ALCHEMY_KEY}`,
      chainId: 11155111,
      accounts: {
        mnemonic: MNEMONIC,
      },
    },
  },
};
```

---

## 1ï¸âƒ£ **Deploy Script**

> `scripts/deploy_sepolia_coprocessor.js`

```js
const hre = require("hardhat");
const fs = require("fs");

async function main() {
  console.log("ğŸš€ Deploying PollFactorySepolia to Sepolia Coprocessor network...");

  const [deployer] = await hre.ethers.getSigners();
  console.log("ğŸ‘¤ Deployer:", deployer.address);

  const Factory = await hre.ethers.getContractFactory("PollFactorySepolia");
  const contract = await Factory.deploy();

  console.log("â³ Waiting for deployment confirmation...");
  await contract.deployed();

  console.log("âœ… Deployed PollFactorySepolia at:", contract.address);

  // Save deployment info
  const output = {
    network: "sepolia",
    address: contract.address,
    deployer: deployer.address,
    timestamp: new Date().toISOString(),
  };
  fs.writeFileSync("deployment.json", JSON.stringify(output, null, 2));
  console.log("ğŸ’¾ Saved deployment.json");

  // Verify
  const code = await hre.ethers.provider.getCode(contract.address);
  console.log(code !== "0x" ? "âœ… Contract verified on chain" : "âŒ Deployment failed!");
}

main().catch((error) => {
  console.error("âŒ Deployment error:", error);
  process.exit(1);
});
```

---

## 2ï¸âƒ£ **Create Poll Script (with FHE encrypted zeros)**

> `scripts/create_poll_with_fhe.js`

```js
const { ethers } = require("hardhat");
const { createInstance } = require("@zama-fhe/relayer-sdk");
const fs = require("fs");
require("dotenv").config();

const SDK_CONFIG = {
  chainId: 11155111,
  networkUrl: `https://eth-sepolia.g.alchemy.com/v2/${process.env.ALCHEMY_KEY}`,
  relayerUrl: "https://relayer.testnet.zama.cloud",
  gatewayUrl: "https://gateway.sepolia.zama.ai/",
  aclContractAddress: "0x687820221192C5B662b25367F70076A37bc79b6c",
  kmsContractAddress: "0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC",
};

async function main() {
  console.log("ğŸ§  Creating poll with encrypted zero counts...");

  const { address: contractAddress } = JSON.parse(fs.readFileSync("deployment.json"));
  const [signer] = await ethers.getSigners();
  console.log("ğŸ‘¤ Using wallet:", signer.address);

  const contract = await ethers.getContractAt("PollFactorySepolia", contractAddress);

  const sdk = await createInstance(SDK_CONFIG);

  const title = "Will Bitcoin reach $200,000 in 2025?";
  const options = ["YES", "NO"];
  const durationHours = 48;
  const duration = durationHours * 3600;

  const encryptedZeros = [];
  const attestations = [];

  for (let i = 0; i < options.length; i++) {
    console.log(`ğŸ” Encrypting initial 0 for option ${options[i]}...`);
    const encryptedInput = await sdk.createEncryptedInput(signer.address, contractAddress);
    const encZero = await encryptedInput.add32(0);
    const attestation = await encryptedInput.encrypt();
    encryptedZeros.push(encZero);
    attestations.push(attestation);
  }

  console.log("ğŸ“¡ Sending createPoll transaction...");
  const tx = await contract.createPoll(title, options, duration, encryptedZeros, attestations);
  console.log("â³ Waiting for confirmation...");
  const receipt = await tx.wait();

  console.log("âœ… Poll created!");
  console.log("   Tx hash:", receipt.transactionHash);
}

main().catch((err) => {
  console.error("âŒ createPoll failed:", err);
  process.exit(1);
});
```

---

## 3ï¸âƒ£ **Vote Script (encrypted vote)**

> `scripts/vote_encrypted.js`

```js
const { ethers } = require("hardhat");
const { createInstance } = require("@zama-fhe/relayer-sdk");
const fs = require("fs");
require("dotenv").config();

const SDK_CONFIG = {
  chainId: 11155111,
  networkUrl: `https://eth-sepolia.g.alchemy.com/v2/${process.env.ALCHEMY_KEY}`,
  relayerUrl: "https://relayer.testnet.zama.cloud",
  gatewayUrl: "https://gateway.sepolia.zama.ai/",
  aclContractAddress: "0x687820221192C5B662b25367F70076A37bc79b6c",
  kmsContractAddress: "0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC",
};

async function main() {
  console.log("ğŸ—³ï¸ Casting encrypted vote...");

  const { address: contractAddress } = JSON.parse(fs.readFileSync("deployment.json"));
  const [signer] = await ethers.getSigners();
  const contract = await ethers.getContractAt("PollFactorySepolia", contractAddress);

  const pollId = 1;
  const selectedOptionIndex = 0; // YES = 0

  const sdk = await createInstance(SDK_CONFIG);
  const encryptedInput = await sdk.createEncryptedInput(signer.address, contractAddress);
  const encryptedVote = await encryptedInput.add32(selectedOptionIndex);
  const attestation = await encryptedInput.encrypt();

  console.log("ğŸ“¡ Sending encrypted vote transaction...");
  const tx = await contract.vote(pollId, encryptedVote, attestation);
  console.log("â³ Waiting for confirmation...");
  const receipt = await tx.wait();

  console.log("âœ… Vote submitted!");
  console.log("   Tx hash:", receipt.transactionHash);
}

main().catch((err) => {
  console.error("âŒ vote failed:", err);
  process.exit(1);
});
```

---

## 4ï¸âƒ£ **Full E2E Test Flow**

> `scripts/full_test_flow.js`

```js
const { execSync } = require("child_process");

async function run(cmd) {
  console.log(`\nâ–¶ï¸ ${cmd}`);
  execSync(cmd, { stdio: "inherit" });
}

async function main() {
  console.log("ğŸ—ï¸ Full fhEVM Coprocessor Test Flow on Sepolia");

  run("npx hardhat run scripts/deploy_sepolia_coprocessor.js --network sepolia");
  run("npx hardhat run scripts/create_poll_with_fhe.js --network sepolia");
  run("npx hardhat run scripts/vote_encrypted.js --network sepolia");

  console.log("\nâœ… All steps completed successfully!");
}

main().catch(console.error);
```

---

## ğŸ§  Summary

| Step                  | Purpose                                 | File                            | Command                                                                   |
| --------------------- | --------------------------------------- | ------------------------------- | ------------------------------------------------------------------------- |
| Deploy contract       | Deploy PollFactorySepolia to Sepolia    | `deploy_sepolia_coprocessor.js` | `npx hardhat run scripts/deploy_sepolia_coprocessor.js --network sepolia` |
| Create encrypted poll | Generate encrypted zeros + attestations | `create_poll_with_fhe.js`       | `npx hardhat run scripts/create_poll_with_fhe.js --network sepolia`       |
| Submit encrypted vote | Encrypt vote option + proof             | `vote_encrypted.js`             | `npx hardhat run scripts/vote_encrypted.js --network sepolia`             |
| Full pipeline         | Run all above sequentially              | `full_test_flow.js`             | `node scripts/full_test_flow.js`                                          |

---

## ğŸ§© Next Steps

If youâ€™d like, I can extend this with:

* A **`decrypt_results.js`** script that uses `FHE.makePubliclyDecryptable` and displays the plaintext results.
* A **frontend React component** to visualize encrypted polls in real time (using SDK decryption hooks).

Would you like me to include those next?


